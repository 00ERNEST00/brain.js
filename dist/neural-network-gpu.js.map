{"version":3,"sources":["../src/neural-network-gpu.js"],"names":["NeuralNetworkGPU","options","Object","assign","defaults","hiddenSizes","hiddenLayers","layers","sizes","outputLayer","biases","weights","outputs","forwardPropagate","backwardPropagate","changesPropagate","weightsPropagate","biasesPropagate","weightsToFloat","megaKernel","deltas","changes","errors","count","error","logCount","gpu","mode","keepNetworkIntact","length","layer","size","Array","node","prevSize","buildRunInput","buildCalculateDeltas","buildGetChanges","buildChangeBiases","data","_options","trainDefaults","formatData","iterations","errorThresh","log","console","logPeriod","learningRate","callback","callbackPeriod","inputSize","input","outputSize","output","push","Math","max","floor","forEach","unshift","initialize","i","sum","j","err","trainPattern","target","runInput","calculateDeltas","getChanges","changeBiases","toArray","weightedSum","x","inputs","k","exp","kernel","createKernelMap","thread","constants","setDimensions","setOutputToTexture","result","calcError","calcDeltas","calcErrorOutput","nextWeights","nextDeltas","calcChanges","previousChange","previousOutputs","momentum","y","addWeights","change","delta","addBiases","inputLookup","outputLookup","toHash","constructor","tmp","datum","Float64Array","buildLookup","map","value","array","binaryThresh"],"mappings":"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","file":"neural-network-gpu.js","sourcesContent":["import lookup from './lookup';\nimport TrainStream from './train-stream';\nimport max from './utilities/max';\nimport mse from './utilities/mse';\nimport randos from './utilities/randos';\nimport range from './utilities/range';\nimport toArray from './utilities/to-array';\nimport zeros from './utilities/zeros';\nimport GPU from 'gpu.js';\n\n/**\n *\n * @param {object} options\n * @constructor\n */\nexport default class NeuralNetworkGPU {\n  constructor(options = {}) {\n    Object.assign(this, NeuralNetworkGPU.defaults, options);\n    this.hiddenSizes = options.hiddenLayers;\n    this.layers = null;\n    this.sizes = null;\n    this.outputLayer = null;\n    this.biases = null; // weights for bias nodes\n    this.weights = null;\n    this.outputs = null;\n\n    this.forwardPropagate = [];\n    this.backwardPropagate = [];\n    this.changesPropagate = [];\n    this.weightsPropagate = [];\n    this.biasesPropagate = [];\n    this.weightsToFloat = [];\n    this.megaKernel = [];\n    // state for training\n    this.deltas = null;\n    this.changes = null; // for momentum\n    this.errors = null;\n    this.count = 0;\n    this.error = 1;\n    this.logCount = options.logCount;\n    this.gpu = new GPU({mode: options.mode});\n  }\n\n  /**\n   *\n   * @param {} sizes\n   * @param {Boolean} keepNetworkIntact\n   */\n  initialize(sizes, keepNetworkIntact) {\n    this.sizes = sizes;\n    this.outputLayer = this.sizes.length - 1;\n\n    if (!keepNetworkIntact) {\n      this.biases = []; // weights for bias nodes\n      this.weights = [];\n      this.outputs = [];\n    }\n\n    // state for training\n    this.changes = []; // for momentum\n    this.deltas = [];\n    this.errors = [];\n\n    for (let layer = 0; layer <= this.outputLayer; layer++) {\n      let size = this.sizes[layer];\n      this.deltas[layer] = zeros(size);\n      this.errors[layer] = zeros(size);\n      if (!keepNetworkIntact) {\n        this.outputs[layer] = zeros(size);\n      }\n\n      if (layer > 0) {\n        this.biases[layer] = randos(size);\n\n        if (!keepNetworkIntact) {\n          this.weights[layer] = new Array(size);\n        }\n        this.changes[layer] = new Array(size);\n\n        for (let node = 0; node < size; node++) {\n          let prevSize = this.sizes[layer - 1];\n          if (!keepNetworkIntact) {\n            this.weights[layer][node] = randos(prevSize);\n          }\n          this.changes[layer][node] = zeros(prevSize);\n        }\n      }\n    }\n    this.buildRunInput();\n    this.buildCalculateDeltas();\n    this.buildGetChanges();\n    this.buildChangeBiases();\n  }\n\n\n  /**\n   *\n   * @param data\n   * @param options\n   * @returns {{error: number, iterations: number}}\n   */\n  train(data, _options = {}) {\n    const options = Object.assign({}, NeuralNetworkGPU.trainDefaults, _options);\n    data = this.formatData(data);\n    let iterations = options.iterations;\n    let errorThresh = options.errorThresh;\n    let log = options.log === true ? console.log : options.log;\n    let logPeriod = options.logPeriod;\n    let learningRate = _options.learningRate || this.learningRate || options.learningRate;\n    let callback = options.callback;\n    let callbackPeriod = options.callbackPeriod;\n    let sizes = [];\n    let inputSize = data[0].input.length;\n    let outputSize = data[0].output.length;\n    let hiddenSizes = this.hiddenSizes;\n    if (!hiddenSizes) {\n      sizes.push(Math.max(3, Math.floor(inputSize / 2)));\n    } else {\n      hiddenSizes.forEach(size => {\n        sizes.push(size);\n      });\n    }\n\n    sizes.unshift(inputSize);\n\n    sizes.push(outputSize);\n\n    this.initialize(sizes, options.keepNetworkIntact);\n\n    let error = 1;\n    let i;\n    for (i = 1; i < 200 && error > errorThresh; i++) {\n      this.count++;\n      let sum = 0;\n      for (let j = 0; j < data.length; j++) {\n        let err = this.trainPattern(data[j].input, data[j].output, learningRate);\n        sum += err;\n      }\n      \n      error = sum / data.length;\n\n      if (log && (i % this.logCount == 0) || log && i == 1) {\n        log('iterations:', i, 'training error:', error);\n      }\n      if (callback && (i % callbackPeriod == 0)) {\n        callback({ error: error, iterations: i });\n      }\n    \n    this.error = error;\n    }\n    return {\n      error: error,\n      iterations: i\n    };\n  }\n\n  /**\n   *\n   * @param input\n   * @param target\n   * @param learningRate\n   */\n  trainPattern(input, target, learningRate) {\n    learningRate = learningRate || this.learningRate;\n    // forward propagate\n    this.runInput(input);\n\n    // backward propagate\n    this.calculateDeltas(target);\n    this.getChanges(learningRate);\n    this.changeBiases(learningRate);\n    \n    if (this.count % this.logCount == 0 || this.count == 1 || this.iterations == this.count) {\n      for (let i = 0; i < this.errors.length; i++) {\n        this.errors[i] = this.errors[i].toArray\n          ? this.errors[i].toArray(this.gpu)\n          : this.errors[i];\n      }\n      let error = this.error = mse(this.errors[this.outputLayer]);\n      return error;\n    } else {\n      return this.error;\n    }\n  }\n\n  buildRunInput() {\n    function weightedSum(weights, biases, x, inputs) {\n      var sum = biases[x];\n      for (var k = 0; k < size; k++) {\n        sum += weights[x][k] * inputs[k];\n      }\n      return 1 / (1 + Math.exp(-sum));\n    }\n\n    for(var layer = 1; layer <= this.outputLayer; layer++){\n      const kernel = this.gpu.createKernelMap({weightedSum}, \n        function(weights, biases, inputs){\n          return weightedSum(weights, biases, this.thread.x, inputs);\n        }, {\n        constants:{\n          size: this.sizes[layer - 1]\n        }\n      })\n      .setDimensions([this.sizes[layer]])\n      .setOutputToTexture(true);\n      this.forwardPropagate[layer] = kernel;\n    }\n  }\n\n  /**\n   *\n   * @param input\n   * @returns {*}\n   */\n  runInput(input){\n    let output;\n    this.outputs[0] = input;\n    for (var layer = 1; layer <= this.outputLayer; layer++) {\n      this.outputs[layer] = this.forwardPropagate[layer](\n        this.weights[layer], \n        this.biases[layer], \n        input\n      ).result;\n\n      output = input = this.outputs[layer];\n    }\n      // console.log(this.outputs[2], 'Outputs')\n    return output;\n  }\n\n  buildCalculateDeltas(target){\n\n    function calcError(outputs, target) {\n      return target[this.thread.x] - outputs;\n    }\n\n    function calcDeltas(error, output) {\n      return error * output * (1 - output);\n    }\n\n    function calcErrorOutput(nextWeights, nextDeltas){\n      var error = 0;\n      for(var k = 0; k < size; k++){\n        error += nextDeltas[k] * nextWeights[k][this.thread.x];\n      }\n      return error;\n    }\n\n    for(var layer = this.outputLayer; layer > 0; layer--){\n      if(layer == this.outputLayer){\n        const kernel = this.gpu.createKernelMap({\n          error: calcError,\n          deltas: calcDeltas\n        }, function(outputs, target){\n          var output = outputs[this.thread.x];\n          return calcDeltas(calcError(output, target), output);\n      })\n       .setDimensions([this.sizes[layer]]) \n       .setOutputToTexture(true);\n        \n        this.backwardPropagate[layer] = kernel;\n\n      }else{\n        const kernel = this.gpu.createKernelMap({\n          error: calcErrorOutput,\n          deltas: calcDeltas,\n        }, function(nextWeights, outputs, nextDeltas){\n          var output = outputs[this.thread.x];\n          return calcDeltas(calcErrorOutput(nextWeights, nextDeltas), output);\n        }, {\n          constants: {\n            size: this.deltas[layer + 1].length\n          }\n        })\n        .setDimensions([this.sizes[layer]])\n        .setOutputToTexture(true);\n        \n        this.backwardPropagate[layer] = kernel;\n      }\n    }\n  }\n\n  calculateDeltas(target,learningRate){\n    for (var layer = this.outputLayer; layer > 0; layer--) {\n      let output;\n      if(layer == this.outputLayer){\n        output = this.backwardPropagate[layer](\n          this.outputs[layer],\n          target);\n      } else {\n        output = this.backwardPropagate[layer](\n          this.weights[layer + 1],\n          this.outputs[layer],\n          this.deltas[layer + 1],\n        )}\n\n      this.deltas[layer] = output.result; \n      this.errors[layer] = output.error;\n    }\n      // console.log(this.errors[2], 'errors');\n      // console.log(this.deltas[2], 'deltas');\n  }\n\n  buildGetChanges(){\n    function calcChanges(previousChange, deltas, previousOutputs, learningRate, momentum, x, y) {\n      var sum = 0;\n      for (var i = 0; i < size; i++) {\n        sum += (learningRate * deltas * previousOutputs[x])\n                + (momentum * previousChange[y][i]);\n      }\n      return sum;\n    }\n\n    function addWeights(change, weights, x, y){\n      return change + weights[y][x];\n    }\n\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n     const kernel = this.gpu.createKernelMap({addWeights, calcChanges},\n        function(previousOutputs, deltas, weights, changes, learningRate, momentum){\n          var delta = deltas[this.thread.y];\n          var change = calcChanges(\n            changes, \n            delta, \n            previousOutputs, \n            learningRate, \n            momentum, \n            this.thread.x, \n            this.thread.y);\n\n          return addWeights(change, weights, this.thread.x, this.thread.y);\n        },{\n          constants:{\n            size: this.outputs[layer - 1].length\n          }\n        })\n          .setDimensions([this.sizes[layer -1], this.sizes[layer]])\n          .setOutputToTexture(true)\n        \n      this.changesPropagate[layer] = kernel;\n    }    \n  }\n  \n  getChanges(learningRate){\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      let output = this.changesPropagate[layer](\n        this.outputs[layer - 1],\n        this.deltas[layer],\n        this.weights[layer],\n        this.changes[layer],\n        learningRate,\n        this.momentum\n      );\n      \n      this.changes[layer] = output.calcChanges;\n      this.weights[layer] = output.result;\n    }\n      // console.log(this.weights[1][0], 'weights');\n      // console.log(this.changes[1][0], 'changes');\n    \n  }\n\n  buildChangeBiases() {\n    function addBiases(biases, deltas, learningRate, x){\n      return biases[x] + (deltas[x] * learningRate);\n    }\n    \n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      const kernel = this.gpu.createKernelMap({\n        addBiases\n      }, function (biases, deltas, learningRate) {\n        return addBiases(biases, deltas, learningRate, this.thread.x);\n      })\n        .setDimensions([this.sizes[layer]])\n        .setOutputToTexture(true);\n\n      this.biasesPropagate[layer] = kernel;\n    }\n  }\n\n  changeBiases(learningRate) {\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      let output = this.biasesPropagate[layer](\n        this.biases[layer],\n        this.deltas[layer],\n        learningRate\n      );\n      this.biases[layer] = output.result;\n    }\n    // console.log(this.biases[2], 'biases')\n  }\n\n  /**\n   *\n   * @param input\n   * @returns {*}\n   */\n  run(input) {\n    if (this.inputLookup) {\n      input = lookup.toArray(this.inputLookup, input);\n    }\n    let output = this.runInput(input);\n\n    if (this.outputLookup) {\n      output = lookup.toHash(this.outputLookup, output);\n    }\n    return output;\n  }\n\n  /**\n   *\n   * @param data\n   * @returns {*}\n   */\n  formatData(data) {\n    if (data.constructor !== Array) { // turn stream datum into array\n      let tmp = [];\n      tmp.push(data);\n      data = tmp;\n    }\n    // turn sparse hash input into arrays with 0s as filler\n    let datum = data[0].input;\n    if (datum.constructor !== Array && !(datum instanceof Float64Array)) {\n      if (!this.inputLookup) {\n        this.inputLookup = lookup.buildLookup(data.map(value => value['input']));\n      }\n      data = data.map(datum => {\n        let array = lookup.toArray(this.inputLookup, datum.input);\n        return Object.assign({}, datum, { input: array });\n      }, this);\n    }\n\n    if (data[0].output.constructor !== Array) {\n      if (!this.outputLookup) {\n        this.outputLookup = lookup.buildLookup(data.map(value => value['output']));\n      }\n      data = data.map(datum => {\n        let array = lookup.toArray(this.outputLookup, datum.output);\n        return Object.assign({}, datum, { output: array });\n      }, this);\n    }\n    return data;\n  }\n\n}\n\nNeuralNetworkGPU.trainDefaults = {\n  iterations: 20000,\n  errorThresh: 0.005,\n  log: false,\n  logPeriod: 10,\n  learningRate: 0.3,\n  callback: null,\n  callbackPeriod: 10,\n  keepNetworkIntact: false\n};\n\nNeuralNetworkGPU.defaults = {\n  learningRate: 0.3,\n  momentum: 0.1,\n  binaryThresh: 0.5,\n  hiddenLayers: null\n};"]}